---

- name: "Copy Helm {{ item }} to host"
  template:
    src: "{{ item }}.yaml.j2"
    dest: "/root/helm/{{ item }}.yaml"
  with_items:
    - jupyter_config
    - secret_config
  register: config
  when: pangeo_state == "present"

- name: Check if the chart exists
  command: helm status {{ pangeo_namespace }}
  register: output
  changed_when: false
  ignore_errors: true

- block:

    - import_tasks: ensure-repo.yml

    - name: Install Pangeo
      command: >
        helm install pangeo/pangeo \
           --namespace={{ pangeo_namespace }} \
           --name={{ pangeo_namespace }} \
           --values /root/helm/secret_config.yaml \
           --values /root/helm/jupyter_config.yaml \
           --version {{ pangeo_version }}

  when:
    - output.rc == 1
    - output.stderr is search('not found')
    - pangeo_state == 'present'

- block:

    - import_tasks: ensure-repo.yml

    - name: Upgrade Pangeo if pangeo_upgrade is true or config has changed
      command: >
        helm upgrade {{ pangeo_namespace }} pangeo/pangeo
           --force --recreate-pods
           --namespace {{ pangeo_namespace }} 
           --values /root/helm/secret_config.yaml
           --values /root/helm/jupyter_config.yaml
           --version {{ pangeo_version }}

  when:
    - output.rc == 0
    - pangeo_state == 'present'
    - pangeo_upgrade | bool or config[0].changed or config[1].changed

- block:

    - name: "Delete Helm manifest for {{ item }}"
      file:
        path: "/root/helm/{{ item }}.yaml"
        state: absent
      with_items:
        - jupyter_config
        - secret_config

    - name: Uninstall Pangeo
      command: helm delete --purge {{ pangeo_namespace }}

  when:
    - output.rc == 0
    - pangeo_state == 'absent'

...
